<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="SMARTIES.MAUI.Views.ScannerPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:SMARTIES.MAUI.ViewModels"
             xmlns:models="clr-namespace:SMARTIES.MAUI.Models"
             xmlns:controls="clr-namespace:SMARTIES.MAUI.Views.Controls"
             x:DataType="viewmodels:ScannerViewModel"
             Title="SMARTIES Scanner"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <Grid RowDefinitions="Auto,*,Auto">
        
        <!-- Header Section -->
        <StackLayout Grid.Row="0" Spacing="10" Padding="20,20,20,10">
            <Label Text="SMARTIES" 
                   FontSize="24" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Primary}" />
            
            <!-- Active Profile Display -->
            <Frame BackgroundColor="{DynamicResource Gray100}" 
                   Padding="10" 
                   CornerRadius="8"
                   IsVisible="{Binding ActiveProfile, Converter={StaticResource IsNotNullConverter}}">
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <Label Text="ðŸ‘¤" FontSize="16" />
                    <Label Text="{Binding ActiveProfile.Name}" 
                           FontSize="14" 
                           FontAttributes="Bold"
                           VerticalOptions="Center" />
                </StackLayout>
            </Frame>
        </StackLayout>

        <!-- Camera View -->
        <controls:SmartiesCameraView Grid.Row="1" 
                                     BindingContext="{Binding}"
                                     IsVisible="{Binding IsScanning}" />
        
        <!-- Scanner Controls (when not scanning) -->
        <StackLayout Grid.Row="1" 
                     Spacing="20" 
                     Padding="20"
                     IsVisible="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}">
            
            <Button Text="ðŸ“· START SCANNING" 
                    FontSize="18" 
                    FontAttributes="Bold"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"
                    HeightRequest="60"
                    CornerRadius="30"
                    Command="{Binding StartScanningCommand}" />

            <!-- Status Message -->
            <Label Text="{Binding StatusMessage}" 
                   FontSize="16" 
                   HorizontalOptions="Center"
                   TextColor="{DynamicResource Gray900}" />

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsProcessing}" 
                               IsVisible="{Binding IsProcessing}"
                               Color="{DynamicResource Primary}" />

            <!-- Current Product Display -->
            <Frame IsVisible="{Binding CurrentProduct, Converter={StaticResource IsNotNullConverter}}"
                   BackgroundColor="White"
                   Padding="15"
                   CornerRadius="10"
                   HasShadow="True">
                <StackLayout Spacing="10">
                    <Label Text="{Binding CurrentProduct.ProductName}" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Gray900}" />
                    
                    <Label Text="{Binding CurrentProduct.Brand}" 
                           FontSize="14" 
                           TextColor="{DynamicResource Gray600}"
                           IsVisible="{Binding CurrentProduct.Brand, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                    
                    <Label Text="{Binding CurrentProduct.Barcode, StringFormat='Barcode: {0}'}" 
                           FontSize="12" 
                           TextColor="{DynamicResource Gray500}" />
                </StackLayout>
            </Frame>

            <!-- Dietary Analysis Results -->
            <Frame IsVisible="{Binding CurrentAnalysis, Converter={StaticResource IsNotNullConverter}}"
                   Padding="15"
                   CornerRadius="10"
                   HasShadow="True">
                <Frame.BackgroundColor>
                    <MultiBinding Converter="{StaticResource ComplianceLevelToColorConverter}">
                        <Binding Path="CurrentAnalysis.OverallCompliance" />
                    </MultiBinding>
                </Frame.BackgroundColor>
                
                <StackLayout Spacing="10">
                    <Label Text="{Binding CurrentAnalysis.Summary}" 
                           FontSize="16" 
                           FontAttributes="Bold"
                           TextColor="White" />
                    
                    <Label Text="{Binding CurrentAnalysis.Recommendation}" 
                           FontSize="14" 
                           TextColor="White" />
                </StackLayout>
            </Frame>
        </StackLayout>

        <!-- Bottom Actions -->
        <StackLayout Grid.Row="2" 
                     Orientation="Horizontal" 
                     Spacing="10" 
                     Padding="20"
                     IsVisible="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}">
            <Button Text="ðŸ‘¤ Profile" 
                    FontSize="14"
                    BackgroundColor="{DynamicResource Secondary}"
                    TextColor="White"
                    CornerRadius="20"
                    Padding="15,8"
                    HorizontalOptions="FillAndExpand" />
            
            <Button Text="ðŸ“‹ History" 
                    FontSize="14"
                    BackgroundColor="{DynamicResource Secondary}"
                    TextColor="White"
                    CornerRadius="20"
                    Padding="15,8"
                    HorizontalOptions="FillAndExpand" />
        </StackLayout>
    </Grid>
</ContentPage>
